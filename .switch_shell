#!/bin/sh
#
# Adam's .switch_shell
#
# Try switch shell if we're interactive, aiming for safety, but
# not so much that we end up hogging memory.
#
# $Id$
#
# Usage:
#
# . /path/to/.switch_shell [-d] [ /path/to/new_shell [ <new shell options> ]
#    -d turns on debugging

# FIXME: move shell chooser code into .ns

# Give hook a .local suffix for consistency in case we need to exclude local stuff
preferred_hook=$HOME/.preferred_shell.local

if [ "$1" = '-d' ]; then
  debug=yes
  shift
fi

myshell=
myshell_args=

if [ -n "$1" ]; then
  myshell="$1"
  shift
  myshell_args="$@"
else
  if [ -e $preferred_hook ]; then
    if grep '=' $preferred_hook >/dev/null 2>&1; then
      . $preferred_hook
#     # Sensible default shell to switch to.
#     myshell=`which zsh` 2>/dev/null
    else
      echo "$preferred_hook doesn't look like a shell script; aborting shell switch" >&2
      return 0
    fi
  fi
fi

if [ -n "$ZDOTDIR" ]; then
  . "$ZDOTDIR/.shared_env"
fi

if sh_load_status "testing if we have sh_load_status" >/dev/null 2>&1; then
  _have_sh_load_status=1
else
  echo "Warning: no sh_load_status" >&2
fi

switch_shell_debug () {
  [ -n "$debug" ] && [ -n "$_have_sh_load_status" ] && sh_load_status "$*\n"
}

if [ -z "$myshell" ]; then
  switch_shell_debug "No shell preference found; not switching shell."
  return 0
fi

# Very cute trick from Bart Schaefer which is a valid alternative approach
#eval `$myshell -f -c "echo exec $myshell" || echo :` '$myshell_args'

switch_shell_safely () {
  # we do this rather than exec() just in case $myshell fails to run.
  switch_shell_debug "Switching to $myshell safely ..."
  if SHELL="$myshell" "$myshell" $myshell_args; then
    switch_shell_debug "$myshell exited OK; exiting parent shell."
    exit
  else
    switch_shell_debug "$myshell had exit code $?, back to pid $$"
  fi
}

switch_shell_dangerously () {
  switch_shell_debug "Switching to $myshell dangerously ..."
  SHELL="$myshell" exec "$myshell" $myshell_args
}

switch_shell () {
  if [ ! -x $myshell ]; then
    switch_shell_debug "$myshell not executable; aborting switch."
    return
  fi

  if [ -n "$NO_SWITCH" ]; then
    switch_shell_debug 'Shell switching disabled by $NO_SWITCH; aborting.'
    return
  fi

  export SHELL_ARGS="$myshell_args" # no other way of retrieving these?

  switch_shell_debug "Switching to $myshell, args: $myshell_args"

  case "$SHLVL" in
   "") # unknown, be careful
       switch_shell_safely $myshell_args
       ;;
    1) # login shell, be careful
       switch_shell_safely $myshell_args
       ;;
    *) # other shell, be risky and save memory
       switch_shell_dangerously $myshell_args
#       switch_shell_safely $myshell_args
       ;;
  esac
}

# only switch if we're interactive
case "$-" in
  *i*) switch_shell $myshell_args ;;
    *) echo "Warning: tried to switch a non-interactive shell" ;;
esac

