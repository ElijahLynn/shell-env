#!/bin/bash

# FIXME: allow non-interactive calling for 50-keyboard

me="keymap-menu"
if [ "`basename $0`" = "$me" ] && [ -n "$*" ]; then
    here=`dirname $0`
    echo -n "Setting up symlinks for keymap-menu in $here ... "
    cd "$here"
    for op in asdf aoeu sdfg; do
        if [ -e $op ]; then
            if [ -h $op ]; then
                : # assume ok
            else
                echo "WARNING: $op already exists in $here" >&2
            fi
        else
            ln -s $me $op
            echo -n " $op"
        fi
    done
    echo
    exit 0
fi

cat <<EOF
Choose from one of the following keymaps:

  1) Standard GB layout
  2) Dell D620 hacked to suit Adam
  3) Dell D630 hacked to suit Adam
  4) Kinesis Essential
  5) Dell D600 "untouched" - as labelled
  6) Samsung N150+ hacked to suit Adam
  7) Microsoft Natural 105-key
  8) Gyration wireless keyboard
  9) HHKL
 10) Dvorak (applies incrementally over existing keymap)

EOF

echo -n "Enter your choice now > "
read choice

XMODMAP_DIR=$ZDOTDIR/.keymaps/X11
KEYMAP_DIR=$ZDOTDIR/.keymaps/Linux-console

unset xmodmap exe keymap xkb

case "$choice" in
    1)
        xkb='-symbols pc+us+gb'
        #xmodmap=$XMODMAP_DIR/Dell-D630-normal
        ;;
    2) 
        xmodmap=$XMODMAP_DIR/Dell-D620-Adam
        ;;
    3)
        xmodmap=$XMODMAP_DIR/Dell-D630-Adam
        ;;
    4)
        exe=$ZDOTDIR/.Xmodmap.d/lib/Kinesis
        #xmodmap=$XMODMAP_DIR/Kinesis-QWERTY
        keymap=$KEYMAP_DIR/uk-kinesis.map
        ;;
    5)
        xmodmap=$XMODMAP_DIR/Dell-D600-untouched
        ;;
    6)
	xkb='-symbols pc+us+gb+adam'
	;;
    7)
        xmodmap=$XMODMAP_DIR/MS-Natural-105
        keymap=/usr/lib/kbd/keymaps/i386/previous/uk.no-capslock.kmap.gz
        ;;
    8)
	xkb='-symbols pc(pc105)+us+gb+adam(gyration)'
        ;;
    9)
	xkb='-geometry hhk -symbols pc+us+gb+adam(hhk)'
        ;;
   10)
        xmodmap=$XMODMAP_DIR/dvorak
        keymap=/usr/lib/kbd/keymaps/i386/dvorak/dvorak.kmap.gz
        ;;
    *) echo "Invalid choice." ; exit 1 ;;
esac

# if tty | grep -q tty; then
#   local sudo=''
#   (( $EUID == 0 )) && sudo=sudo
#   $sudo loadkeys $keymap
# fi

if [ -n "$xmodmap" ]; then
    xmodmap "$xmodmap"
fi

if [ -n "$xkb" ]; then
    setxkbmap $xkb -print | \
        xkbcomp -I$ZDOTDIR/.xkb - $DISPLAY 2>&1 | \
        egrep -v 'Warning: +No symbols defined for'
fi

if [ -n "$exe" ]; then
    "$exe"
fi

. $ZDOTDIR/.shared_env
. $ZDOTDIR/.zsh/functions/enable_nullglob

for hook in $( . $ZDOT_FIND_HOOKS ".keymaps/post-change.d" ); do
  echo "Running post-change hook $hook ..."
  "$hook"
done
