#!/bin/sh
# 
# Copies the entire contents of one directory to another, even if some
# subdirectories are common to both source and destination directories.
#
# This is preferred to rsync when you don't want to overwrite destination
# files (accomplished via tar -k), and to unison when the destination
# tree is substantially larger/different to the source tree.
#
# Adam Spiers <me@adamspiers.org>
#

set -e
me=`basename $0`

if [ $# != 2 ]; then
  cat <<'EOF' >&2
Usage: $me <src dir> <dest dir>
N.B. Use rsync unless you want to avoid overwriting files in destination tree!
EOF
  exit 1
fi

src="$1"
dest="$2"
if ! [ -d "$src"  ]; then
  echo "No such directory '$src'" >&2
  exit 1
fi
if ! [ -d "$dest"  ]; then
  echo "No such directory '$dest'" >&2
  exit 1
fi

oldpwd=`pwd`

cd "$dest"
absdest=`pwd`
temptar="`mktemp $absdest/$me.$$.tar.XXXXXX`"

cd "$oldpwd"
cd "$src"
#if ! find . -maxdepth 1 -print0 | tar -cf "$temptar" --null --files-from=-; then
if ! tar -cf "$temptar" .; then
  echo "$me: failed to create '$temptar'" >&2
  exit 1
fi

#echo "Created $temptar" >&2

cd "$oldpwd"
cd "$dest"
# -k => keep existing files
if ! tar -xkf "$temptar"; then
  echo "$me: failed to untar '$temptar'" >&2
  exit 1
fi

#echo "Extracted $temptar in $dest" >&2

rm "$temptar"
