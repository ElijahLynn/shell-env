#!/bin/sh

me=`basename $0`

usage () {
    if [ -n "$1" ]; then
        echo "$*" >&2
        echo
    fi

    cat <<EOF >&2
Usage: $me SOFT_THRESHOLD HARD_THRESHOLD
e.g. $me 12:30am 1am
     $me '11pm yesterday' 12am

Warns if the user is active after SOFT_THRESHOLD.
Shuts down if the user is active after HARD_THRESHOLD.
EOF
}

if [ "$1" == '-h' ] || [ "$1" == '--help' ] || [ -z "$2" ]; then
    usage
fi

soft="$1"
hard="$2"

if out=$( active-since "$hard" ); then
    logger "would shutdown! $out"
    exit 1
fi

if out=$( active-since "$soft" ); then
    echo "WARNING: activity after $hard will shutdown system!" \
    | write "`id -un`" "`uidle --tty`"
    exit 1
fi

echo "Threshold not crossed"
exit 0
